jobs:
  - job: ValidationChecks
    displayName: Distro and Extension Validation
    timeoutInMinutes: 15
    steps:
      - template: ./common/checkout.yml@self

      - task: NodeTool@0
        inputs:
          versionSource: fromFile
          versionFilePath: .nvmrc

      - template: ./distro/download-distro.yml@self

      - script: node build/azure-pipelines/distro/mixin-quality.ts
        displayName: Mixin distro quality

      - task: AzureKeyVault@2
        displayName: "Azure Key Vault: Get Secrets"
        inputs:
          azureSubscription: vscode
          KeyVaultName: vscode-build-secrets
          SecretsFilter: "github-distro-mixin-password"

      - script: npm ci
        workingDirectory: build
        env:
          GITHUB_TOKEN: "$(github-distro-mixin-password)"
        displayName: Install build dependencies

      - script: node build/azure-pipelines/common/checkDistroCommit.ts
        displayName: Check distro commit
        env:
          GITHUB_TOKEN: "$(github-distro-mixin-password)"
          BUILD_SOURCEBRANCH: "$(Build.SourceBranch)"
        continueOnError: true

      - script: node build/azure-pipelines/common/checkCopilotChatCompatibility.ts --warn-only
        displayName: Check Copilot Chat compatibility
        continueOnError: true
